name: Build Releases (Windows & Linux)

on:
  release:
    types: [created]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v4
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install .
        pip install pyinstaller windows-curses PyQt6 pillow
    - name: Build Windows Exe
      run: |
        pyinstaller --noconfirm --onefile --windowed --name "MusicPlayerCthulhu" --add-data "musicplayer/assets;musicplayer/assets" --icon "musicplayer/assets/frame1.png" --hidden-import "musicplayer" run_gui.py
    - name: Upload Windows Artifact
      uses: actions/upload-artifact@v4
      with:
        name: MusicPlayerCthulhu-Windows
        path: dist/MusicPlayerCthulhu.exe
    - name: Add to Release
      if: github.event_name == 'release'
      uses: softprops/action-gh-release@v2
      with:
        files: dist/MusicPlayerCthulhu.exe

  build-linux:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    - name: Install System Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libegl1 libxcb-cursor0 libxkbcommon-x11-0 mpv
    - name: Install Python Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install .
        pip install pyinstaller PyQt6 yt-dlp
    - name: Build Linux Binary
      run: |
        pyinstaller --noconfirm --onefile --windowed --name "MusicPlayerCthulhu-Linux" --add-data "musicplayer/assets:musicplayer/assets" --icon "musicplayer/assets/frame1.png" --hidden-import "musicplayer" run_gui.py
    - name: Upload Linux Artifact
      uses: actions/upload-artifact@v4
      with:
        name: MusicPlayerCthulhu-Linux
        path: dist/MusicPlayerCthulhu-Linux
    - name: Add to Release
      if: github.event_name == 'release'
      uses: softprops/action-gh-release@v2
      with:
        files: dist/MusicPlayerCthulhu-Linux
