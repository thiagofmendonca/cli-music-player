name: Build Releases (Windows & Linux)

on:
  release:
    types: [created]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v4
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install .
        pip install pyinstaller windows-curses PyQt6 pillow certifi
    
    - name: Download libmpv (Windows)
      shell: powershell
      run: |
        Invoke-WebRequest -Uri "https://sourceforge.net/projects/mpv-player-windows/files/libmpv/mpv-dev-x86_64-20240428-git-072023d.7z/download" -OutFile "libmpv.7z" -UserAgent "NativeHost"
        7z e libmpv.7z -o. mpv-2.dll
        dir mpv-2.dll

    - name: Build Windows Exe
      run: |
        pyinstaller --noconfirm --onefile --windowed --name "FreeThulluPlayer" --add-data "musicplayer/assets;musicplayer/assets" --add-binary "mpv-2.dll;." --additional-hooks-dir=hooks --icon "musicplayer/assets/frame1.png" --hidden-import "musicplayer" --hidden-import "certifi" run_gui.py
    - name: Upload Windows Artifact
      uses: actions/upload-artifact@v4
      with:
        name: FreeThulluPlayer-Windows
        path: dist/FreeThulluPlayer.exe
    - name: Add to Release
      if: github.event_name == 'release'
      uses: softprops/action-gh-release@v2
      with:
        files: dist/FreeThulluPlayer.exe

  build-linux:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    - name: Install System Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libegl1 libxcb-cursor0 libxkbcommon-x11-0 mpv
    - name: Install Python Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install .
        pip install pyinstaller PyQt6 yt-dlp certifi
    - name: Build Linux Binary
      run: |
        pyinstaller --noconfirm --onefile --windowed --name "FreeThulluPlayer-Linux" --add-data "musicplayer/assets:musicplayer/assets" --additional-hooks-dir=hooks --icon "musicplayer/assets/frame1.png" --hidden-import "musicplayer" --hidden-import "certifi" run_gui.py
    - name: Upload Linux Artifact
      uses: actions/upload-artifact@v4
      with:
        name: FreeThulluPlayer-Linux
        path: dist/FreeThulluPlayer-Linux
    - name: Add to Release
      if: github.event_name == 'release'
      uses: softprops/action-gh-release@v2
      with:
        files: dist/FreeThulluPlayer-Linux
